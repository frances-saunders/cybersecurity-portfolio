# ---------------------------------------------
# Malware/C2 Signatures (generic web beacons & patterns)
# Author: Your Name
# Purpose: Catch common commodity malware beacons and packers
# Notes:
#  - Keep generic; avoid vendor fingerprints
#  - Flowbits used for staged detection (User-Agent + path)
# ---------------------------------------------

# Suspicious User-Agent often used by commodity loaders
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (
    msg:"MALWARE Suspicious User-Agent minimal client";
    flow:to_server,established;
    content:"User-Agent|3A 20|Python-requests/"; http_header; nocase;
    flowbits:set,suspicious_ua;
    classtype:trojan-activity;
    metadata:service http,attack_target Web,policy balanced-ips drop;
    sid:1000301; rev:3;
)

# Beaconing to known C2-like paths (gate.php, connect.php, update.php)
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (
    msg:"MALWARE Possible C2 path indicator";
    flow:to_server,established;
    http_uri;
    pcre:"/\/(gate|connect|update)\.php(\?|$)/Ri";
    flowbits:isset,suspicious_ua;
    classtype:trojan-activity;
    metadata:service http,attack_target Web,policy security-ips drop;
    detection_filter:track by_dst, count 10, seconds 300;
    sid:1000302; rev:4;
)

# PE file over HTTP (suspicious download)
alert tcp $EXTERNAL_NET $HTTP_PORTS -> $HOME_NET any (
    msg:"MALWARE Portable Executable download over HTTP";
    flow:to_client,established;
    file_data; content:"MZ"; depth:2; # PE header
    http_header; content:"Content-Type|3A| application/octet-stream"; nocase;
    classtype:trojan-activity;
    metadata:service http,attack_target Endpoint,policy balanced-ips drop;
    sid:1000303; rev:3;
)

# Suspicious outbound to dynamic DNS providers (generic)
var DYNAMIC_DNS "dynu.com|duckdns.org|no-ip.com|ddns.net|hopto.org|myftp.biz"
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (
    msg:"MALWARE potential dynDNS C2";
    flow:to_server,established;
    http_header; content:"Host|3A 20|"; within:6; nocase;
    pcre:"/Host\x3a\x20([^\r\n]+)(${DYNAMIC_DNS})/Ri";
    classtype:trojan-activity;
    metadata:service http,attack_target Web,policy balanced-ips drop;
    sid:1000304; rev:2;
)

# ---------------------------------------------
# Brute Force Detection Rules
# Author: Your Name
# Purpose: Detect password brute force attempts
# Notes:
#  - Tuned to reduce FP by requiring flow, thresholds, and service context
#  - SIDs range reserved: 1000000-1000999 (local)
# ---------------------------------------------

# SSH brute force (multiple failures from same source)
# - Matches repeated "Failed password" strings in syslog or application logs forwarded via syslog.
# - If you monitor raw network SSH handshakes only, rely on connection rate (see rule 2).
alert tcp $EXTERNAL_NET any -> $HOME_NET 22 (
    msg:"BRUTE-FORCE SSH failed password attempt (log-derived)";
    flow:established,to_server;
    app-layer-protocol:tls,ssh;
    content:"Failed password for"; nocase; fast_pattern;
    pcre:"/Failed\s+password\s+for\s+(invalid\s+user\s+)?\w+/Ri";
    classtype:attempted-recon;
    metadata:attack_target Server,service ssh,policy balanced-ips drop;
    reference:url,attack.mitre.org/techniques/T1110/;
    detection_filter:track by_src, count 6, seconds 60;
    sid:1000001; rev:5;
)

# SSH connection rate heuristic (network-only, no log content)
# - Detects excessive new SSH sessions (SYNs reaching server) from a single source.
# - Useful when content inspection isn't available (encrypted).
alert tcp $EXTERNAL_NET any -> $HOME_NET 22 (
    msg:"BRUTE-FORCE SSH excessive connection attempts";
    flags:S; flow:stateless;
    threshold:type both, track by_src, count 20, seconds 60;
    classtype:attempted-recon;
    metadata:attack_target Server,service ssh,policy security-ips drop;
    reference:url,attack.mitre.org/techniques/T1110/;
    sid:1000002; rev:6;
)

# HTTP basic auth brute force (401 storms)
# - Detects repeated 401 Unauthorized on the same resource from same source.
# - Pair with web server logs in SIEM for correlation.
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (
    msg:"BRUTE-FORCE HTTP 401 Unauthorized storm";
    flow:to_server,established;
    http_method; content:"GET"; http_method;
    http_stat_code; content:"401"; http_stat_code;
    detection_filter:track by_src, count 10, seconds 30;
    classtype:attempted-user;
    metadata:service http,attack_target WebApp,policy balanced-ips drop;
    sid:1000003; rev:4;
)

# RDP brute force heuristic (multiple failed RDP negotiations)
# - TCP/3389 repeated connections in short window
alert tcp $EXTERNAL_NET any -> $HOME_NET 3389 (
    msg:"BRUTE-FORCE RDP excessive connection attempts";
    flags:S; flow:stateless;
    threshold:type both, track by_src, count 15, seconds 60;
    classtype:attempted-recon;
    metadata:service rdp,attack_target Workstation,policy balanced-ips drop;
    sid:1000004; rev:3;
)

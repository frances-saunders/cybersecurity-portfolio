# Race Telemetry Secure Pipeline
# ------------------------------
# Secrets are pulled from Key Vault, never echoed or hardcoded.

trigger: none

stages:
  - stage: Ingest
    jobs:
      - job: StreamTelemetry
        steps:
          - script: |
              echo "Simulating live race telemetry ingestion..."
              python ingest_telemetry.py --eventhub "$EVENTHUB_CONNSTRING"
            env:
              EVENTHUB_CONNSTRING: $(keyVault.eventhubConnection)

  - stage: Process
    jobs:
      - job: ProcessCosmos
        steps:
          - script: |
              echo "Processing telemetry and inserting into Cosmos DB..."
              python process_to_cosmos.py --cosmos-uri "$COSMOS_URI" --cosmos-key "***"
            env:
              COSMOS_URI: $(keyVault.cosmosUri)
              COSMOS_KEY: $(keyVault.cosmosKey)

  - stage: Archive
    jobs:
      - job: ArchiveSQL
        steps:
          - script: |
              echo "Archiving telemetry into Azure SQL..."
              python archive_sql.py --server "$SQL_SERVER" --db "$SQL_DB" --user "$SQL_USER" --password "***"
            env:
              SQL_SERVER: $(keyVault.sqlServer)
              SQL_DB: $(keyVault.sqlDB)
              SQL_USER: $(keyVault.sqlUser)
              SQL_PASS: $(keyVault.sqlPassword)
